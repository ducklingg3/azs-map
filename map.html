<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<style>html,body,#map{height:100%;margin:0;padding:0;}</style>
</head>
<body>
<div id="map"></div>
<script>
const stations = [
    {name: "Бектемир", address: "г.Ташкент, Бектемирский р-н, проспект Бектемир, дом 31 А", lat: 41.229307, lon: 69.333984},
    {name: "ТТЗ", address: "г.Ташкент, М.Улугбекский р-н, пересечение улиц Гулсанам и Юзработ", lat: 41.359402, lon: 69.382904},
    {name: "Чинабад", address: "г.Ташкент, М.Улугбекский р-н, МКАД, по улице Чинабад", lat: 41.32926, lon: 69.310914},
    {name: "Корасув", address: "г.Ташкент, М.Улугбекский р-н, ул.Авайхон, дом 5", lat: 41.31201, lon: 69.344072},
    {name: "Сергели-1", address: "г.Ташкент, Сергелинский р-н, ул.Новая Сергели, 61-й км МКАД", lat: 41.230742, lon: 69.2055465}
];

const map = L.map('map').setView([41.3111,69.2797],11);
L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'}).addTo(map);

const markers = L.markerClusterGroup();
stations.forEach(s=>{
    const m = L.marker([s.lat,s.lon],{
        icon:L.AwesomeMarkers.icon({icon:'gas-pump',markerColor:'blue',prefix:'fa'})
    }).bindPopup(`<b>${s.name}</b><br>${s.address}`);
    markers.addLayer(m);
});
map.addLayer(markers);

if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
        const lat=pos.coords.latitude, lon=pos.coords.longitude;
        const user=L.marker([lat,lon],{icon:L.AwesomeMarkers.icon({icon:'user',markerColor:'red',prefix:'fa'})}).bindPopup("Вы здесь").addTo(map).openPopup();
        map.setView([lat,lon],13);
        const nearest=stations.map(s=>({...s,distance:map.distance([lat,lon],[s.lat,s.lon])})).sort((a,b)=>a.distance-b.distance);
        nearest.slice(0,3).forEach(s=>{
            const nm=L.marker([s.lat,s.lon],{icon:L.AwesomeMarkers.icon({icon:'gas-pump',markerColor:'green',prefix:'fa'})}).bindPopup(`<b>${s.name}</b><br>${s.address}`);
            nm.addTo(map);
        });
    },()=>alert("Не удалось определить ваше местоположение"));
} else alert("Геолокация не поддерживается");
</script>
</body>
</html>
